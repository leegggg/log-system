# 日志系统测试

本章主要是针对前述的系统实现，对整个日志系统进行功能测试和性能测试。测试各个组件的工作性能，集成后的整体效果，各个API的工作情况，前端展示和使用等各方面的功能，并发现其中可能存在的问题，或者需要优化的技术问题，对整体细节方面进行完善。

## 测试环境

本节首先对软硬件配置进行介绍。

### 软件环境

日志系统作为MSCP平台的一部分存在，MSCP平台各模块所用到的软件如下：

| 模块 | 软件 | 版本 |
| --------   | -----:  | :----:  |
| portal | beego | 1.9.0 |
|  | angularJS | 4.0.0 |
| stoage | 

### 硬件环境

## 性能测试

### ElasticSearch性能测试
#### 测试方法

通过journalbeat和logstash不断以最大速度向ElasticSearch写入数据从而测试ElasticSearch的写入性能。数据来源是系统journald中积攒的系统日志。根据经验，journalBeat，logstash产生日志的速度大大高于ElasticSearch的落盘速度。

#### 测试基准

ElasticSearch 配置：
* 1个Master Node，JVM：heap size设置为2048MB 
* 1个Client Node，JVM：heap size设置为2048MB 
* 2个Data Node，JVM：heap size设置为2048MB 

Indice 配置：5分片1备份

基准数据：ElasticSearch落盘速度为172 Doc/s

对ElasticSearch Data节点的Log发现有大量超过1s 的full gc发生。进一步分析其gc log发现gc耗时大约占了总运行时间的40%（1267.59s/3786s）由此分析，我们认为系统的瓶颈在于ES Data的内存不足。

####纵向扩展
我们在维持Data节点数量为2不变的情况下提高JVM heap size测试结果如下

![JVM heap size](jvm_heap_size_chart.png)

我们可以看到，随着数据Heap size的提高Elasticsearch集群的写入性能不断提高。

通过对Gc log的分析我们发现，在Heap size到达6Gb时gc耗时<10%（321.03s/3723s），运行过程中没有发生full gc， heap占用峰值被良好的控制在80%左右，平均Heap占用维持在3.7GiB左右。我们由此认为6GiB的Heap Size是一个合适的值。

在Heap size达到8GiB之后，虽然集群性能依然能得到少许提高，但是根据对Gc log的分析我们发现ElasticSearch Data节点对Heap的平均使用只有4GiB左右。我们认为这样的操作是得不偿失的。

#### 水平扩展 

在确定6GiB的Heap Size为合适值后我们尝试对ElasticSearch Data节点进行水平扩展，提高ElasticSearch Data节点的数量来提高性能。下图展示了我们的测试结果：

 ![nb_node](nb_node_chart.png)

由上图可见在Data Node的个数达到5时集群性能有了大幅提升，我们认为这是由于分片的个数被设置为5造成的。根据Elastic.io提供的指南，Data节点的个数在被设置为分片数量的倍数时比较合适。所以在这里我们在安装脚本中将ElasticSearch Data 节点的个数默认设置为5。

#### 其他可以提高Log系统性能的方案
1.	降低log Document的大小，在我们的测试中Log Document的大小大约为2KiB其中包括了30种以上的属性。而log信息则包含在其中一个叫message的属性中。这样的Document效率比较低，可以考虑删除部分不会用到的属性。
2.	调整ElasticSearch中的Mapping设置对一些字段不进行分词等操作，降低集群的压力。
3.	调整ElasticSearch中分片和备份的数量，降低备份数量有利于提高性能但是ElasticSearch集群将会丧失节点失效时自动恢复和Scale In的能力。
4.	在Logstash和ElasticSearch集群中加入Message queue。

### Kafka性能测试

## 功能测试
### Journald中的日志收集
### Logfile中的日志收集
### 日志推送
### 日志批量写入
### 日志查询
### 用户token签发
### 用户隔离日志写入
### 用户隔离日志读取

## 其他测试
### 高可用测试

### ElasticSearch水平扩展测试

### kafka水平扩展测试