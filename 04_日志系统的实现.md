#日志系统设计
##用户鉴权的实现
由于后面日志收集API，日志查询API都需要用到用户鉴权所以我们在此首先介绍我们的用户鉴权的实现。
##数据收集组件的实现
本组件主要包括三部分，第一部分是基于journald和JournalBeat对容器内控制台数据的收集的实现。第二部分是基于FileBeat对容器内日志文件的收集的实现。第三部分是日志推送接口的实现。
### 容器控制台日志的收集
容器内日志控制台日志的收集过程如下图所示：
![alt text](container_log_collection.png "Container log collection")
为了让docker能给将容器中控制台中的日志数据发送到journald。首先需要对kubernetes计算节点上运行的docker service进行设置。修改，docker service的定义文件，在我们基于centos7.2的计算节点上该文件是`/etc/systemd/system/docker.service`
在docker的启动参数中加入或者修改参数`--log-driver`的值为`journald`然后通过`systemctl restart docker.service`重启docker守护程序，以使配置生效。
docker容器发送到journald中的数据可以通过journalctl程序读出，journalctl支持将日志数据组织成json形式输出，其典型结构如下：
```
{
  "__CURSOR": "s=d8478c3862d347e59d28104ba4edb24d;i=144dd0;b=b4d5f19eb0fa4460a1155cdb19fcdcf9;m=f1125097aa;t=54f14690b9edf;x=19866ec227042b69",
  "__REALTIME_TIMESTAMP": "1494323963862751",
  "__MONOTONIC_TIMESTAMP": "1035394389930",
  "_BOOT_ID": "b4d5f19eb0fa4460a1155cdb19fcdcf9",
  "_UID": "0",
  "_GID": "0",
  "_CAP_EFFECTIVE": "1fffffffff",
  "_SYSTEMD_SLICE": "system.slice",
  "_MACHINE_ID": "374b5aca51ba4246989cf37facd31d0b",
  "_HOSTNAME": "kvm-009660.novalocal",
  "_TRANSPORT": "journal",
  "_COMM": "dockerd",
  "_EXE": "/usr/bin/dockerd",
  "_SYSTEMD_CGROUP": "/system.slice/docker.service",
  "_SYSTEMD_UNIT": "docker.service",
  "PRIORITY": "3",
  "_PID": "22279",
  "_CMDLINE": "dockerd --insecure-registry=0.0.0.0/0 --graph=/var/lib/docker --iptables=true --log-driver=journald --bip=10.254.44.1/24 --mtu=1400 --dns 10.253.0.2 --dns 10.0.12.217 --dns 10.0.12.216 --dns-search default.svc.cluster.local --dns-search svc.cluster.local --dns-search openstacklocal --dns-search novalocal --dns-opt ndots:2 --dns-opt timeout:2 --dns-opt attempts:2",
  "MESSAGE": "2017-05-09 09:59:23.854320 I | flags: recognized and used environment variable ETCD_HEARTBEAT_INTERVAL=250",
  "CONTAINER_ID": "b8eb401d22c8",
  "CONTAINER_ID_FULL": "b8eb401d22c8576cd98061c4d0227968ffd8fb725c0e412c70e3cdae8104ec47",
  "CONTAINER_NAME": "k8s_kube-controller-manager.905f3855_kube-controller-manager-kvm-009660_kube-system_7cc96a847ece6fad70a98b9db56bd08d_01130b8b",
  "CONTAINER_TAG": "b8eb401d22c8",
  "_SOURCE_REALTIME_TIMESTAMP": "1494323963855249"
}
```
其中`MESSAGE`字段是应用实际提交的日志信息，`CONTAINER_NAME`字段提供容器名称。其中由kubernetes管理的应用的名称一般包含了关于日志来源的信息如容器所属的pod，deployment，namespace的名称等。我们将利用这些信息来确定日志来源，为日志入库归档提供依据。`_REALTIME_TIMESTAMP`字段记录了日志数据被journald接收到的时间点。这是一个微秒级的时间戳，标识了自UNIX纪元（1970-01-01 00:00:00 UTC）开始已经过的微秒数。根据linux man7的解释，这个时间点一般略晚于由应用自己汇报的日志产生时间`_SOURCE_REALTIME_TIMESTAMP`。但是其优势在于首先这个数值由journald直接生成不会被用户应用“欺骗”，其次有更好的唯一性，比较不容易出现诸如两条日志拥有同样的时间戳的情况。我们选择这一字段作为日志排序的主要依据。
           The wallclock time (CLOCK_REALTIME) at the point in time the
           entry was received by the journal, in microseconds since the
           epoch UTC, formatted as a decimal string. This has different
           properties from "_SOURCE_REALTIME_TIMESTAMP=", as it is usually a
           bit later but more likely to be monotonic.
### 容器内日志文件的收集

### 日志推送接口

##数据清洗组件

##数据缓存组件

##数据存储组件

##数据查询和集群管理组件

##前端UI